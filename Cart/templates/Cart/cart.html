{% extends 'products/base.html' %}
{% load static %}

{% block content %}
{% include 'products/header.html' %}
{% include 'products/navigation.html' %}

<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="#">Home</a>
                <a class="breadcrumb-item text-dark" href="#">Shop</a>
                <span class="breadcrumb-item active">Shopping Cart</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->


<!-- Cart Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-lg-8 table-responsive mb-5">
            <table class="table table-light table-borderless table-hover text-center mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th></th>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody class="align-middle">
                   {% for item in cart %}
                   {% with product=item.product %}
                    <tr  class = "cart-item" data-index = {{product.sku}}>
                        <td class="align-left"><img src="{{item.image}}" alt="" style="width: 50px;"></td>
                        <td class="align-left">{{product| slice:"20"}}
                        </td>
                        <td class="align-middle">${{item.price}}</td>
                        <td class="align-middle">
                            <div class="input-group quantity mx-auto" style="width: 100px;">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-primary btn-minus update-item-in-cart" data-index={{product.sku}}>
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                                <input type="text"
                                    class="form-control form-control-sm bg-secondary border-0 text-center product-quantity" id = "product-quantity{{product.sku}}" data-index ="{{product.sku}}" value="{{item.quantity}}">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-primary btn-plus update-item-in-cart" data-index={{product.sku}}>
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">${% if cart_total %}{{cart_total}}{% else %}{{item.total_price}}{% endif %} </td>
                        <td class="align-middle"><button id = "delete-item-from-cart" class="btn btn-sm btn-danger delete-item-from-cart" data-index ="{{product.sku}}" ><i
                                    class="fa fa-times"></i></button></td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-lg-4">
            <form class="mb-30" action="">
                <div class="input-group">
                    <input type="text" class="form-control border-0 p-4" placeholder="Coupon Code">
                    <div class="input-group-append">
                        <button class="btn btn-primary">Apply Coupon</button>
                    </div>
                </div>
            </form>
            <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Cart
                    Summary</span></h5>
            <div class="bg-light p-30 mb-5">
                <div class="border-bottom pb-2">
                    <div class="d-flex justify-content-between mb-3">
                        <h6>Subtotal</h6>
                        <div class = "d-inline-flex"><h6>$ </h6><h6 id = "sub-total">{{cart.get_total_price}}</h6></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <h6 class="font-weight-medium">Shipping</h6>
                        <h6 class="font-weight-medium">$0</h6>
                    </div>
                </div>
                <div class="pt-2">
                    <div class="d-flex justify-content-between mt-2">
                        <h5>Total</h5>
                        <div class = "d-inline-flex"><h5>$ </h5><h5 id = "total">{{cart.get_total_price}}</h5></div>
                    </div>
                    <button class="btn btn-block btn-primary font-weight-bold my-3 py-3">Proceed To Checkout</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Cart End -->
{% include 'products/footer.html' %}


<script>
    {% comment %} Deleting an item from cart {% endcomment %}
    $(document).on('click', '.delete-item-from-cart', function (e) {
        e.preventDefault();
        var product = $(this).data('index');
        $.ajax({
            type: 'POST',
            url: '{% url "cart:cart-delete" %}',
            data: {
                product_meta: $(this).data('index'),                
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: 'delete'
            },
            success: function (json) {
                $('.cart-item[data-index="'+ product +'"]').remove();
                document.getElementById("cart-quantity").innerHTML = json.quantity
                document.getElementById("sub-total").innerHTML = json.total
                document.getElementById("total").innerHTML = json.total
            },
            error: function (xhr, errmsg, err) {}
        });
    })

{% comment %} Editing/ Updating Item in cart {% endcomment %}
$(document).on('click', '.update-item-in-cart', function (e) {
    e.preventDefault();
    var product = $(this).data('index');
    $.ajax({
        type: 'POST',
        url: '{% url "cart:cart-update" %}',
        data: {
            product_sku: $(this).data('index'),   
            product_quantity: $('#product-quantity'+ product).val(),             
            csrfmiddlewaretoken: "{{csrf_token}}",
            action: 'update'
        },
        success: function (json) {
            document.getElementById("cart-quantity").innerHTML = json.quantity
            document.getElementById("sub-total").innerHTML = json.total
            document.getElementById("total").innerHTML = json.total
        },
        error: function (xhr, errmsg, err) {}
    });
})

</script>


{% endblock %}