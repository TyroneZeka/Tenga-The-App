{% extends 'products/base.html' %}
{% load static %}

{% block content %}
{% include 'products/header.html' %}
{% include 'products/navigation.html' %}

<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="#">Home</a>
                <a class="breadcrumb-item text-dark" href="#">Shop</a>
                <span class="breadcrumb-item active">Delivery Address</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->
<div class="container">
    <div class="col-12">
      <h1 class="h2">Delivery Address</h1>
    </div>
    <div class="col-12">
      <p>Please select your delivery address</p>
    </div>
    <hr />
  </div>
  
  
  <div class="container">
    <div class="row g-3">
      {% if addresses|length == 0 %}
      <div class="col-12">There are no delivery addresses, <a href="{% url 'users:add_address' %}">add address</a></div>
      {% else %}
      <div class="col-md-4 col-lg-4 order-md-last p-0 order-3">
      
  <div class="d-flex bd-highlight ms-0">
    <div class="p-2 flex-grow-1 bd-highlight">Sub Total:</div>
    <div class="p-2 bd-highlight"><span class="fw-bold h5">$</span><span id="sub_total"class="fw-bold h5">{{cart.get_subtotal_price}}</span></div>
  </div>
  <div class="d-flex bd-highlight">
    <div class="p-2 flex-grow-1 bd-highlight">Delivery Cost:</div>
    <div class="p-2 bd-highlight"><span class="fw-bold h5">$</span><span id="delivery_price" class="fw-bold h5">{{cart.get_delivery_price}}</span></div>
  </div>
  <div class="d-flex bd-highlight">
    <div class="p-2 flex-grow-1 bd-highlight">Total:</div>
    <div class="p-2 bd-highlight"><span class="fw-bold h5">$</span><span id="total"class="fw-bold h5">{{cart.get_total_price}}</span></div>
  </div>
  <div id = "paypal-button-container"></div>
  </div>
    
   
      <div class="col-md-7 col-lg-8">
        {% for address in addresses %}
        {% if not address.default %}
          <h1 class="h5 pt-4">Other Addresses</h1>
        {% endif %}
        <div class="card mb-3 border-1 rounded-0 product-item me-md-4" data-index="{{option.id}}">
          <div class="row g-0">
            <div class="col">
              <div class="card pb-3 rounded-0">
                <div class="card-header bg-white small text-muted">
                  {% if address.default %}
                  Selected
                  {% endif %}
                  &nbsp;
                </div>
                <div class="card-body small pb-1">
                  <p class="card-text m-0 fw-bold">{{request.user}}</p>
                  <p class="card-text m-0">{{address.address1}}</p>
                  <p class="card-text m-0">{{address.address2}}</p>
                  <p class="card-text m-0">{{address.city}}</p>
                  <p class="card-text m-0">{{address.post_code}}</p>
                  <p class="card-text m-0">Phone number: {{request.user.phone}}</p>
                  {% comment %} <div class="pt-5">
                    <a href="{% url 'account:edit_address' address.id %}" class="text-decoration-none">Edit</a>
                    {% if not address.default %}
                    | <a href="{% url 'account:set_default' address.id %}" class="text-decoration-none">Select</a>
                    {% endif %}
                  </div> {% endcomment %}
                </div>
              </div>
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  
  </div>
{% include 'products/footer.html' %}

<script src="https://www.paypal.com/sdk/js?client-id=AffSe9pBjD5LzUGrNBPEVbAvHGjq8bDMf8aqH0MDXGZrpkmsUoQgCcKDRHaurgWes86K4N6Omo8n6R11&currency=USD"></script>
    <script>

      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      var csrftoken = getCookie('csrftoken');
    

      paypal.Buttons({
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: '{{cart.get_total_price}}', // Can also reference a variable or function
                currency_code: "USD"
              }
            }]
          });
        },
        // Finalize the transaction after payer approval
        onApprove: (data, actions) => {
          var url = "{% url 'checkout:payment_complete' %}"
          return fetch(url,{
            method: 'POST',
            headers:{
              'content-type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stryingfy({
              orderID:data.orderID
            })
          }).then(function(){
            location.href = '{% url 'checkout:payment_successful' %}';
          })
        }
      }).render('#paypal-button-container');
    </script>

{% endblock %}